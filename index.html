<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>책표지 URL 추출 (srchDtlList · 단일파일)</title>
<style>
  :root { --fg:#111; --muted:#666; --line:#eee; }
  body { font-family: system-ui, -apple-system, sans-serif; color:var(--fg);
         max-width: 880px; margin: 24px auto; padding: 0 12px; }
  h1 { font-size: 20px; margin: 0 0 12px; }
  .controls { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: end; }
  .grid1 { display:grid; grid-template-columns: 1fr; gap:8px; }
  .muted { color: var(--muted); font-size: 12px; }
  input[type="text"], textarea { padding: 8px; width: 100%; box-sizing: border-box; }
  textarea { min-height: 140px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  button { padding: 10px 14px; cursor: pointer; }
  .banner { padding: 10px 12px; border-radius: 8px; margin: 12px 0; border: 1px solid transparent; }
  .banner.info { background:#eef6ff; border-color:#c9e1ff; }
  .banner.error { background:#ffe8e8; border-color:#ffb2b2; }
  .banner.success { background:#e9f8ed; border-color:#b4e3c3; }
  table { border-collapse: collapse; width: 100%; margin: 12px 0 0; }
  th, td { border: 1px solid var(--line); padding: 6px 8px; vertical-align: top; }
  th { background: #f7f7f7; text-align: left; }
  td.url { word-break: break-all; }
  td img { max-height: 120px; }
  .actions { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 16px; }
  .small { font-size: 12px; }
  .right { text-align:right; }
  .fail { color:#b00020; }
</style>

<h1>책표지 URL 추출 (srchDtlList)</h1>

<div class="controls">
  <div>
    <div class="grid1">
      <input id="key" type="text" placeholder="data4library authKey (승인 후 사용)">
    </div>
    <div class="muted">※ 정적 페이지라 키는 입력으로만 써. 하드코딩 금지.</div>
  </div>
  <button id="go" type="button" onclick="onGoClick()">조회</button>
</div>

<div style="margin-top:8px;">
  <div class="muted small">ISBN 목록(줄바꿈/쉼표/스페이스 상관없음 · 10자리/13자리 섞여도 됨):</div>
  <textarea id="isbnBox">9788936433598
9788979196184</textarea>
</div>

<div class="actions">
  <button id="copyMd" disabled>마크다운 표 복사</button>
  <button id="downloadCsv" disabled>CSV 다운로드</button>
  <div class="right small" style="margin-left:auto">
    <span id="count">대기 0</span>
  </div>
</div>

<div id="banner"></div>
<div id="tableBox"></div>

<details>
  <summary class="small">디버그 보기</summary>
  <pre id="debug" class="small" style="white-space:pre-wrap; overflow:auto; max-height: 50vh;"></pre>
</details>

<script>
  // ===== 유틸 =====
  const $ = s => document.querySelector(s);
  const banner = $("#banner");
  const dbg = $("#debug");
  const copyBtn = $("#copyMd");
  const csvBtn = $("#downloadCsv");
  const countEl = $("#count");

  function showBanner(type, msg){ banner.className = `banner ${type}`; banner.textContent = msg; }
  function clearBanner(){ banner.className = ""; banner.textContent = ""; }
  function setDebug(txt){ dbg.textContent = txt || ""; }
  function appendDebug(txt){ if (!txt) return; dbg.textContent += (dbg.textContent ? "\n" : "") + txt; }
  const pretty = (obj) => JSON.stringify(obj, null, 2);
  function maskKey(k){ if (!k) return ""; const t = k.trim(); return t.length > 8 ? (t.slice(0,4) + "…" + t.slice(-4)) : "****"; }
  function redactKeyInUrl(u){
    try { const x = new URL(u); if (x.searchParams.has("authKey")) x.searchParams.set("authKey", maskKey(x.searchParams.get("authKey"))); return x.toString(); }
    catch { return u; }
  }
  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  // ISBN 함수들
  function isbn10to13(isbn10){
    const s = String(isbn10).replace(/[^0-9X]/gi, "").toUpperCase();
    if (s.length !== 10) return null;
    const base = "978" + s.slice(0, 9); // 10번째(검증자)는 버리고 9자리만 사용
    // 13자리 체크디지트 계산
    let sum = 0;
    for (let i=0; i<12; i++){
      const d = parseInt(base[i], 10);
      sum += (i % 2 === 0) ? d : d * 3;
    }
    const chk = (10 - (sum % 10)) % 10;
    return base + String(chk);
  }

  function parseISBNs(raw){
    // 폭넓게 추출: 13자리 숫자 또는 10자리(마지막 X 허용)
    const norm = String(raw || "").replace(/[\u00A0\u1680\u2000-\u200B\u202F\u205F\u3000]+/g, " ");
    const matches = norm.match(/\d{13}|\d{9}[\dXx]/g) || [];
    const out = [];
    const seen = new Set();
    for (const m of matches){
      let v = m;
      if (m.length === 10) {
        const t = isbn10to13(m);
        if (!t) continue;
        v = t;
      }
      // 13자리만 최종 사용
      if (v.length === 13 && !seen.has(v)) { seen.add(v); out.push(v); }
    }
    return out;
  }

  // ===== API 호출 =====
  function buildDtlURL(authKey, isbn13){
    const u = new URL("https://data4library.kr/api/srchDtlList");
    u.searchParams.set("authKey", authKey);
    u.searchParams.set("isbn13", isbn13);
    u.searchParams.set("format", "json");
    return u.toString();
  }

  function pickBook(obj){
    const resp = obj?.response ?? obj;
    const det = resp?.detail;
    const entry = Array.isArray(det) ? det[0] : det;
    const book = entry?.book ?? entry ?? {};
    return {
      isbn13: book.isbn13 ?? book.isbn ?? "",
      bookname: (book.bookname ?? "").toString(),
      bookImageURL: (book.bookImageURL ?? "").toString()
    };
  }

  async function fetchDtlOnce(authKey, isbn13){
    const url = buildDtlURL(authKey, isbn13);
    appendDebug("srchDtlList 요청: " + redactKeyInUrl(url));
    let res;
    try {
      // Accept 헤더 지정하지 않음 (406 회피)
      res = await fetch(url);
    } catch (e) {
      appendDebug("네트워크 오류: " + e.message);
      return { isbn13, error: "네트워크 오류" };
    }

    const ctype = (res.headers.get("content-type") || "").toLowerCase();
    let text = "";
    try { text = await res.text(); }
    catch (e) { appendDebug("본문 읽기 실패: " + e.message); return { isbn13, error:"응답 본문 읽기 실패" }; }

    // 상태 코드 나빠도 일단 파싱 시도 (서버가 에러를 JSON으로 줄 때가 있음)
    let json = null;
    if (text.trim().startsWith("{") || text.trim().startsWith("[")) {
      try { json = JSON.parse(text); } catch {}
    }
    if (!json) {
      appendDebug(`JSON 아님(content-type=${ctype})\n본문 앞부분:\n` + text.slice(0, 300));
      return { isbn13, error: "JSON 아님/응답 형식 오류" };
    }

    // API 에러 바디 처리(중단 금지! 실패로만 기록)
    const resp = json?.response ?? json;
    const err = resp?.error ?? json?.error;
    if (err) {
      appendDebug("응답(에러 바디):\n" + pretty(json));
      const msg = typeof err === "string" ? err : (err.message || "API 오류");
      return { isbn13, error: msg };
    }

    const row = pickBook(json);
    if (!row.isbn13) row.isbn13 = isbn13;
    appendDebug("OK → " + row.isbn13 + " : " + row.bookname);
    return row;
  }

  // ===== 렌더 =====
  const results = []; // {isbn13, bookname?, bookImageURL?, error?}
  function render(){
    const box = $("#tableBox");
    const rows = results;
    if (!rows.length){ box.innerHTML = ""; copyBtn.disabled = true; csvBtn.disabled = true; return; }

    const html = [
      `<table><thead><tr><th>bookname</th><th>bookImageURL</th><th>표지</th><th>isbn13</th><th>상태</th></tr></thead><tbody>`,
      ...rows.map(r => {
        if (r.error){
          return `<tr>
            <td class="fail" colspan="2">실패: ${escapeHtml(r.error)}</td>
            <td></td>
            <td>${escapeHtml(r.isbn13||"")}</td>
            <td class="fail">FAIL</td>
          </tr>`;
        } else {
          const name = escapeHtml(r.bookname || "");
          const url = r.bookImageURL || "";
          const img = url ? `<img src="${escapeAttr(url)}" alt="">` : "";
          return `<tr>
            <td>${name}</td>
            <td class="url"><a href="${escapeAttr(url)}" target="_blank" rel="noopener">${escapeHtml(url)}</a></td>
            <td>${img}</td>
            <td>${escapeHtml(r.isbn13 || "")}</td>
            <td>OK</td>
          </tr>`;
        }
      }),
      `</tbody></table>`
    ].join("");

    box.innerHTML = html;

    // 액션 버튼 활성화 + 내보내기
    copyBtn.disabled = false; csvBtn.disabled = false;

    const md = [
      "| bookname | bookImageURL |",
      "|---|---|",
      ...rows.map(r => r.error
        ? `| (실패: ${r.error.replace(/\|/g, "\\|")}) | ${r.isbn13 || ""} |`
        : `| ${escapePipes(r.bookname||"")} | ${r.bookImageURL||""} |`)
    ].join("\n");

    copyBtn.onclick = async () => {
      try { await navigator.clipboard.writeText(md); alert("복사 완료!"); }
      catch { alert("복사 실패. 표 텍스트를 수동 복사해."); }
    };

    csvBtn.onclick = () => {
      const header = ["bookname","bookImageURL","isbn13","status"];
      const data = rows.map(r => r.error
        ? ["", "", r.isbn13 || "", `FAIL: ${r.error}`]
        : [r.bookname || "", r.bookImageURL || "", r.isbn13 || "", "OK"]);
      const csv = [header, ...data].map(row => row.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "covers.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(a.href), 1000);
    };
  }

  function escapePipes(s){ return String(s ?? "").replace(/\|/g, "\\|"); }
  function escapeHtml(s){ return String(s ?? "").replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
  function escapeAttr(s){ return String(s ?? "").replace(/"/g, '&quot;'); }

  // ===== 실행 =====
  let running = false;
  async function onGoClick(){
    if (running) return;
    const key = $("#key").value.trim();
    const input = $("#isbnBox").value;
    const isbns = parseISBNs(input);

    setDebug("");
    results.length = 0;
    render();

    if (!key){ showBanner("error", "API 키 넣어."); return; }
    if (isbns.length === 0){ showBanner("error", "ISBN이 없음."); return; }

    running = true;
    $("#go").disabled = true;
    showBanner("info", `조회 중… (${maskKey(key)}) · 총 ${isbns.length}권`);
    countEl.textContent = `대기 ${isbns.length}`;

    for (let i=0; i<isbns.length; i++){
      const isbn = isbns[i];
      const row = await fetchDtlOnce(key, isbn);
      results.push(row);
      render(); // 누적 즉시 반영
      countEl.textContent = `진행 ${i+1}/${isbns.length} · OK ${results.filter(x=>!x.error).length} · FAIL ${results.filter(x=>x.error).length}`;
      await sleep(120); // 레이트리밋 여유
    }

    clearBanner();
    $("#go").disabled = false;
    running = false;
  }
  window.onGoClick = onGoClick; // inline onclick용 노출
</script>
</html>
