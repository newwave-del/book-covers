<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ISBN → 제목 + 커버 URL (Aladin OpenAPI)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap: 10px; --pad: 12px; --border:#ddd; --muted:#666; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; line-height:1.4; padding:20px; max-width:980px; margin:0 auto; }
    h1 { font-size:1.2rem; margin:0 0 12px; }
    .row { display:flex; gap:var(--gap); flex-wrap:wrap; align-items:center; }
    .row > * { flex:1 1 auto; }
    label { font-weight:600; font-size:.95rem; }
    input[type="text"], textarea, input[type="number"] {
      width:100%; padding:var(--pad); border:1px solid var(--border); border-radius:8px; font-size:.95rem;
    }
    textarea { min-height:160px; resize:vertical; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    button { padding:10px 14px; border:1px solid #111; background:#111; color:#fff; border-radius:8px; cursor:pointer; font-weight:700; }
    button.secondary { background:#fff; color:#111; border:1px solid #111; }
    button.warn { background:#b00020; border-color:#b00020; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    small { color:var(--muted); }
    .status { margin-top:10px; font-size:.95rem; }
    progress { width:100%; height:10px; border:1px solid var(--border); border-radius:6px; }
    table { width:100%; border-collapse:collapse; margin-top:14px; }
    th, td { border:1px solid var(--border); padding:8px 10px; text-align:left; vertical-align:top; font-size:.95rem; }
    th { background:#fafafa; }
    .fail { color:#b00020; font-weight:700; }
    .ok { color:#0a7a2f; font-weight:700; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .right { text-align:right; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); }
    @media (max-width:720px){ .grid { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <h1>ISBN → 제목 + 커버 URL (Aladin OpenAPI)</h1>

  <div class="grid">
    <div>
      <label for="ttb">TTBKey</label>
      <input id="ttb" type="text" placeholder="예: TTBXXXXXXXXXXXX" autocomplete="off" />
      <small>키는 알라딘 OpenAPI에서 발급. 키 등록한 URL에서 실행해야 응답 정상. 일 5,000회 제한.</small>
      <div style="height:10px"></div>
      <label for="isbn">ISBN 목록 (줄바꿈/쉼표/공백 아무거나)</label>
      <textarea id="isbn" placeholder="9788937473133
9780143127796
406290715X"></textarea>
      <div class="row" style="margin-top:6px">
        <div>
          <label for="delay">호출 간 간격(ms)</label>
          <input id="delay" type="number" value="200" min="0" step="50" />
          <small>연속 호출 방지용. 너무 낮추면 차단될 수 있음.</small>
        </div>
        <div>
          <label for="maxn">최대 처리 개수(선택)</label>
          <input id="maxn" type="number" placeholder="빈 칸이면 전체" min="1" />
          <small>테스트할 때 일부만.</small>
        </div>
      </div>
      <div class="controls">
        <button id="runBtn">조회 시작</button>
        <button id="stopBtn" class="warn" disabled>중지</button>
        <button id="clearBtn" class="secondary">초기화</button>
      </div>
      <div class="controls">
        <button id="csvBtn" class="secondary" disabled>CSV 다운로드</button>
        <button id="mdBtn" class="secondary" disabled>Markdown 복사</button>
      </div>
      <div class="status">
        <div>진행: <span id="count">0/0</span></div>
        <progress id="bar" value="0" max="100"></progress>
        <div><small id="hint" class="mono"></small></div>
      </div>
    </div>

    <div>
      <table id="tbl">
        <thead>
          <tr>
            <th style="width:56px">#</th>
            <th>ISBN</th>
            <th>제목</th>
            <th>커버 URL</th>
            <th style="width:80px">상태</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
(() => {
  const $ = (s) => document.querySelector(s);
  const ttbEl = $('#ttb');
  const isbnEl = $('#isbn');
  const delayEl = $('#delay');
  const maxnEl = $('#maxn');
  const runBtn = $('#runBtn');
  const stopBtn = $('#stopBtn');
  const clearBtn = $('#clearBtn');
  const csvBtn = $('#csvBtn');
  const mdBtn  = $('#mdBtn');
  const bar = $('#bar');
  const countEl = $('#count');
  const hintEl = $('#hint');
  const tbody = $('#tbl tbody');

  let stopFlag = false;
  let rows = [];  // {idx,isbn,title,cover,status}

  function parseIsbns(raw) {
    // 숫자, 하이픈, 공백, 콤마 등 섞여도 10(끝 X 허용)/13자리만 뽑기
    const norm = (s) => s.replace(/[^0-9Xx]/g,'').toUpperCase();
    const tokens = raw.split(/[\s,;]+/).map(norm).filter(Boolean);
    // 추가로 본문에서 ISBN 패턴 전체 스캔
    const extra = (raw.match(/(?:97[89][-\s]?)?\d{9}[\dXx]|\b\d{13}\b/g) || []).map(norm);
    const all = [...tokens, ...extra];
    const out = [];
    const seen = new Set();
    for (const t of all) {
      if (t.length===13 || t.length===10) {
        if (!seen.has(t)) { seen.add(t); out.push(t); }
      }
    }
    return out;
  }

  function idType(isbn) {
    return isbn.length === 13 ? 'ISBN13'
         : isbn.length === 10 ? 'ISBN'
         : 'UNKNOWN';
  }

  function delay(ms){ return new Promise(r=>setTimeout(r, ms)); }

  // JSONP 호출: Aladin은 output=js + callback 지원 (문서상 CallBack 파라미터 표기도 있음)
  // 응답 형태가 callback(payload) 또는 callback(true, payload) 모두 처리
  function jsonp(url, timeoutMs=12000) {
    return new Promise((resolve, reject) => {
      const cbName = '__aladin_cb_' + Date.now() + '_' + Math.random().toString(36).slice(2);
      const s = document.createElement('script');
      let timeout = setTimeout(() => {
        cleanup();
        reject(new Error('timeout'));
      }, timeoutMs);

      window[cbName] = function(arg1, arg2) {
        clearTimeout(timeout);
        const isErr = (typeof arg2 !== 'undefined') ? !!arg1 : false;
        const data = (typeof arg2 !== 'undefined') ? arg2 : arg1;
        cleanup();
        if (isErr) reject(new Error('api_error'));
        else resolve(data);
      };

      function cleanup(){
        delete window[cbName];
        if (s.parentNode) s.parentNode.removeChild(s);
      }

      const glue = url.includes('?') ? '&' : '?';
      s.src = url + glue + 'callback=' + cbName + '&CallBack=' + cbName; // 둘 다 붙여 호환성 확보
      s.onerror = () => { clearTimeout(timeout); cleanup(); reject(new Error('network_error')); };
      document.head.appendChild(s);
    });
  }

  function buildUrl({ttbkey, isbn}) {
    const type = idType(isbn);
    const params = new URLSearchParams({
      ttbkey: ttbkey.trim(),
      itemIdType: type,
      ItemId: isbn,
      output: 'js',
      Version: '20131101'
    });
    // HTTPS 사용
    return 'https://www.aladin.co.kr/ttb/api/ItemLookUp.aspx?' + params.toString();
  }

  function addRow(idx, isbn) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="right">${idx}</td>
      <td class="mono">${isbn}</td>
      <td class="title"></td>
      <td class="mono coverurl"></td>
      <td class="stat"></td>
    `;
    tbody.appendChild(tr);
    return tr;
  }

  function setRow(tr, {title, cover, status}) {
    tr.querySelector('.title').textContent = title || '';
    tr.querySelector('.coverurl').textContent = cover || '';
    const st = tr.querySelector('.stat');
    st.textContent = status;
    st.className = 'stat ' + (status==='OK' ? 'ok' : (status.startsWith('FAIL') ? 'fail' : ''));
  }

  async function run() {
    const ttbkey = ttbEl.value.trim();
    if (!ttbkey) { alert('TTBKey 넣어.'); return; }

    const list = parseIsbns(isbnEl.value);
    const limit = parseInt(maxnEl.value, 10);
    const target = Number.isFinite(limit) && limit>0 ? list.slice(0, limit) : list.slice();

    if (target.length === 0) { alert('ISBN이 없음.'); return; }

    // UI state
    runBtn.disabled = true; stopFlag = false; stopBtn.disabled = false;
    csvBtn.disabled = true; mdBtn.disabled = true;
    tbody.innerHTML = ''; rows = [];
    bar.value = 0; bar.max = target.length; countEl.textContent = `0/${target.length}`;
    hintEl.textContent = `ItemLookUp ISBN 모드 (output=js, JSONP) — ${new Date().toLocaleTimeString()}`;

    const gap = Math.max(0, parseInt(delayEl.value,10) || 0);

    let done = 0;
    for (let i=0;i<target.length;i++){
      if (stopFlag) break;
      const isbn = target[i];
      const tr = addRow(i+1, isbn);

      try {
        const url = buildUrl({ttbkey, isbn});
        const data = await jsonp(url);
        // 기대 구조: { item: [ { title, cover, ... } ], ... }
        const item = data && Array.isArray(data.item) && data.item.length ? data.item[0] : null;
        const title = item && (item.title || '').toString();
        const cover = item && (item.cover || '').toString();
        if (!item || !title) {
          setRow(tr, {title:'', cover:'', status:'FAIL(no_item)'});
          rows.push({idx:i+1, isbn, title:'', cover:'', status:'FAIL'});
        } else {
          setRow(tr, {title, cover, status:'OK'});
          rows.push({idx:i+1, isbn, title, cover, status:'OK'});
        }
      } catch (e) {
        const code = e && e.message ? e.message : 'error';
        setRow(tr, {title:'', cover:'', status:`FAIL(${code})`});
        rows.push({idx:i+1, isbn, title:'', cover:'', status:`FAIL(${code})`});
      }

      done++;
      bar.value = done; countEl.textContent = `${done}/${target.length}`;
      if (gap) await delay(gap);
    }

    stopBtn.disabled = true;
    runBtn.disabled = false;
    csvBtn.disabled = rows.length>0;
    mdBtn.disabled  = rows.length>0;
  }

  function toCSV(rows) {
    const esc = (s) => {
      if (s==null) return '';
      s = String(s);
      return /[",\n]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s;
    };
    const head = ['idx','isbn','title','cover_url','status'];
    const body = rows.map(r => [r.idx, r.isbn, r.title, r.cover, r.status].map(esc).join(',')).join('\n');
    return head.join(',') + '\n' + body + '\n';
  }

  function toMarkdown(rows) {
    const lines = [];
    lines.push('| # | ISBN | 제목 | 커버 URL | 상태 |');
    lines.push('|:-:|:---|:---|:---|:-:|');
    for (const r of rows) {
      const safeTitle = (r.title || '').replace(/\|/g,'\\|');
      const safeUrl = (r.cover || '').replace(/\|/g,'\\|');
      lines.push(`| ${r.idx} | ${r.isbn} | ${safeTitle} | ${safeUrl} | ${r.status} |`);
    }
    return lines.join('\n') + '\n';
  }

  function downloadText(filename, text) {
    const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    URL.revokeObjectURL(url);
    a.remove();
  }

  async function copyText(text) {
    try {
      await navigator.clipboard.writeText(text);
      alert('복사 완료.');
    } catch {
      // iPad 사파리 대비: 실패 시 임시 textarea
      const ta = document.createElement('textarea');
      ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
      alert('복사 완료(대체 경로).');
    }
  }

  runBtn.addEventListener('click', run);
  stopBtn.addEventListener('click', ()=>{ stopFlag = true; stopBtn.disabled = true; });
  clearBtn.addEventListener('click', ()=>{
    tbody.innerHTML = ''; rows = []; bar.value = 0; bar.max=100; countEl.textContent='0/0'; hintEl.textContent='';
    csvBtn.disabled = true; mdBtn.disabled = true;
  });
  csvBtn.addEventListener('click', ()=> downloadText('aladin_isbn_results.csv', toCSV(rows)));
  mdBtn.addEventListener('click', ()=> copyText(toMarkdown(rows)));
})();
</script>
</body>
</html>
